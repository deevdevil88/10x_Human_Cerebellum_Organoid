---
title: "Organoid_Cerebellum_Pseudobulk_Brainspan_comparison"
author: "Devika Agarwal"
date: 'Last update: `r date()`'
output:
  html_document:
    number_sections: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: yes
      toc_depth: 6
---
<style type="text/css">

body{ /* Normal  */
      font-size: 12px;
  }
td {  /* Table  */
  font-size: 10px;
}
h1.title {
  font-size: 20px;
  color: DarkRed;
}
h1 { /* Header 1 */
  font-size: 20px;
  color: DarkBlue;
}
h2 { /* Header 2 */
    font-size: 18px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 14px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r r setup, include=FALSE, message=FALSE, warning=FALSE}
library(Seurat)
library(tidyverse)
library(dplyr)
library(Matrix)
library(data.table)
library(ggplot2)
library(biomaRt)
library(limma)
library(sva)
knitr::opts_chunk$set(cache=TRUE,echo=T,message=FALSE,warning=FALSE,cache.lazy = FALSE)
## white background theme for all plots
theme_set(theme_bw())
 setwd("~/Documents/Sams_Cerebellum_code")
 
Vector2Colour <- function(clase, ucol2 = c("red", "blue"), alfa = .8, Pal = "Blues"){
  colores <- vector(length = length(clase))
  if(is.numeric(clase)){
    pal1 <- colorRampPalette(brewer.pal(n = 9, name = Pal)[3:9], space = "Lab")
    ucol <- pal1(length(unique(clase)))
    rk <- rank(clase)
    rku <- unique(rk)
    rku <- rku[order(rku)]
    for (i in c(1:length(ucol))){
      colores[which(rank(clase) == rku[i])] <- ucol[i]    
    }
  } else {
    if(length(unique(clase)) == 2){
      ucol <- ucol2
      for (i in c(1:length(ucol))){
        colores[which(clase == unique(clase)[i])] <- ucol[i]    
      }
    } else {
      if(length(unique(clase)) < 9){
        pal1 <- brewer.pal(9, "Set1")[-6] # Remove yellow
        ucol <- pal1[1:length(unique(clase))]
        for (i in c(1:length(ucol))){
          colores[which(clase == unique(clase)[i])] <- ucol[i]    
        }
      } else {
        if(length(unique(clase)) > 8){
          pal1 <- colorRampPalette(brewer.pal(n = 7, name = "Dark2"), space = "Lab")
          ucol <- pal1(length(unique(clase)))
          for (i in c(1:length(ucol))){
            colores[which(clase == unique(clase)[i])] <- ucol[i]    
          }
        }
      }
    }  
  }
  colores <- alpha(colores, alpha = alfa)
  return(colores)
}

```

## Load and process Brainspan data
+ Expression matrix in Brainspan is RPKM values

```{r }
brainspan_original <- read.csv(file = "./genes_matrix_csv/expression_matrix.csv", sep=",",header=F)
brainspan_colnames <- read.csv(file="./genes_matrix_csv/columns_metadata.csv", sep=",")
brainspan_rownames <- read.csv(file="./genes_matrix_csv/rows_metadata.csv", sep=",")
brainspan_original <- brainspan_original[,-1]

rownames(brainspan_original) <- brainspan_rownames$ensembl_gene_id
library(plyr)
brainspan_colnames$dev_period <- brainspan_colnames$age
#brainspan_colnames$dev_period <- plyr::revalue(brainspan_colnames$dev_period, c("1 yrs"="Childhood","10 mos"="Infancy","11 yrs" ="Childhood","12 pcw"= "Early_prenatal","13 pcw"="Early_mid_prenatal","13 yrs" = "Adolescence","15 yrs"="Adolescence","16 pcw"="Early_mid_prenatal", "17 pcw"="Early_mid_prenatal","18 yrs"="Adolescence","19 pcw"="Late_mid_prenatal", "19 yrs"="Adolescence", "2 yrs"= "Childhood", "21 pcw"="Late_mid_prenatal", "21 yrs"="Adults","23 yrs" ="Adults", "24 pcw" ="Late_mid_prenatal", "25 pcw"="Late_prenatal", "26 pcw"="Late_prenatal", "3 yrs"="Childhood", "30 yrs"="Adults", "35 pcw"="Late_prenatal","36 yrs" ="Adults","37 pcw"="Late_prenatal", "37 yrs"="Adults", "4 mos"= "Infancy", "4 yrs" ="Childhood", "40 yrs"="Adults","8 pcw"="Early_prenatal", "8 yrs" ="Childhood","9 pcw"= "Early_prenatal" ))

brainspan_colnames$dev_period <- plyr::revalue(brainspan_colnames$dev_period, c("1 yrs"="Infancy","10 mos"="Infancy","11 yrs" ="Childhood","12 pcw"= "Early_prenatal","13 pcw"="Early_prenatal","13 yrs" = "Adolescence","15 yrs"="Adolescence","16 pcw"="Early_prenatal", "17 pcw"="Early_prenatal","18 yrs"="Adolescence","19 pcw"="Late_prenatal", "19 yrs"="Adults", "2 yrs"= "Childhood", "21 pcw"="Late_prenatal", "21 yrs"="Adults","23 yrs" ="Adults", "24 pcw" ="Late_prenatal", "25 pcw"="Late_prenatal", "26 pcw"="Late_prenatal", "3 yrs"="Childhood", "30 yrs"="Adults", "35 pcw"="Late_prenatal","36 yrs" ="Adults","37 pcw"="Late_prenatal", "37 yrs"="Adults", "4 mos"= "Infancy", "4 yrs" ="Childhood", "40 yrs"="Adults","8 pcw"="Early_prenatal", "8 yrs" ="Childhood","9 pcw"= "Early_prenatal" ))




# renames level 1 cell suptyes to major cell classes
brainspan_colnames$brain_region_short <- brainspan_colnames$structure_acronym
brainspan_colnames$brain_region_short <-  plyr::revalue(brainspan_colnames$brain_region_short, c("A1C"="Cortical", "AMY"="Amygdaloid","CB"="Cerebellum","CBC"="Cortical","CGE"="Ganglionic_eminence","DFC"="Cortical","DTH"="Thalamus","HIP"="Hippocampus","IPC"="Cortical","ITC"="Cortical","LGE"="Ganglionic_eminence","M1C"="Cortical","M1C-S1C"="Cortical","MD"="Thalamus","MFC"="Cortical", "MGE"="Ganglionic_eminence","Ocx"="Cortical","OFC"="Cortical","PCx"="Cortical","S1C"="Cortical","STC"="Cortical","STR"="Striatum","TCx"="Cortical", "URL"="URL","V1C"="Cortical","VFC"="Cortical"))

brainspan_colnames$Sample_ID  <- paste(brainspan_colnames$structure_acronym,"_",brainspan_colnames$dev_period,sep="")
write.table(brainspan_colnames, file="brainspan_colnames_extended.txt", sep="\t",quote=F)

colnames(brainspan_original) <- brainspan_colnames$Sample_ID

# First average by Dev period and then by Tissue
#brainspan_original <- read.table(file="./brainspan_original_extended.txt",header=T)
brainspan_original_t <- as.data.frame(t(brainspan_original))
brainspan_original_t$Sample_ID <- brainspan_colnames$Sample_ID
#brainspan_original_t$Sample_ID <- gsub('\\..*', '', brainspan_original_t$Sample_ID, perl=T)
#brainspan_original_t$Sample_ID <- rownames(brainspan_original_t)
brainspan_original_t$Sample_ID <- as.factor(brainspan_original_t$Sample_ID)
brainspan_original_t_1 = brainspan_original_t %>%
                  group_by(Sample_ID) %>%
                  summarise_all(mean) 
brainspan_original_t_1 <- as.data.frame(brainspan_original_t_1)
brainspan_original_t_1 <- brainspan_original_t_1[match(brainspan_metadata$Sample_ID, brainspan_original_t_1$Sample_ID),]
rownames(brainspan_original_t_1) <- brainspan_original_t_1$Sample_ID
#drops <- "Sample_ID"
brainspan_original_t_1 <- subset(brainspan_original_t_1, select=-c(Sample_ID))
rm(brainspan_original_t)

brainspan_original <- as.data.frame(t(brainspan_original_t_1))
write.table(brainspan_original, file="brainspan_processed_extended_prenatal.txt", sep="\t",quote=F)
rm(brainspan_original_t_1)

brainspan_metadata <- brainspan_colnames %>% distinct(Sample_ID, .keep_all = TRUE)
write.table(brainspan_metadata, file="brainspan_metadata_extended_prenatal.txt", sep="\t", quote=F)

```

# Load in Cynthias processed brainspan object

```{r}
brainspan_processed <- read.table(file="./brainspan_processed", sep="\t",header=T, row.names=1)
brainspan_metadata <- as.data.frame(colnames(brainspan_processed))
library(stringr)
brainspan_metadata_1 <-  str_split_fixed(brainspan_metadata$`colnames(brainspan_processed)`, "_", 2)
brainspan_metadata_1 <- as.data.frame(brainspan_metadata_1)
colnames(brainspan_metadata_1)[1] <- "brain_region"
colnames(brainspan_metadata_1)[2] <- "maturity_stage"

library(plyr)
brainspan_metadata_1$brain_region_short <- brainspan_metadata_1$brain_region
# renames level 1 cell suptyes to major cell classes
brainspan_metadata_1$brain_region_short <-  revalue(brainspan_metadata_1$brain_region_short, c("A1C"="Cortical", "AMY"="Amygdaloid","CB"="Cerebellum","CBC"="Cortical","CGE"="Ganglionic_eminence","DFC"="Cortical","DTH"="Thalamus","HIP"="Hippocampus","IPC"="Cortical","ITC"="Cortical","LGE"="Ganglionic_eminence","M1C"="Cortical","M1C.S1C"="Cortical","MD"="Thalamus","MFC"="Cortical", "MGE"="Ganglionic_eminence","Ocx"="Cortical","OFC"="Cortical","PCx"="Cortical","S1C"="Cortical","STC"="Cortical","STR"="Striatum","TCx"="Cortical", "URL"="URL","V1C"="Cortical","VFC"="Cortical"))

brainspan_metadata_1$Sample_ID <- brainspan_metadata$`colnames(brainspan_processed)`
brainspan_metadata_1$Study <- "Brainspan"
#col_order <- c("Sample_ID","Replicate","Group","Study","brain_region")

#brainspan_metadata_1 <- brainspan_metadata_1[,col_order]

rownames(brainspan_metadata_1) <- brainspan_metadata_1$Sample_ID
```



# Read in Sams Seurat object


```{r pressure, echo=FALSE}
Sams_obj <- readRDS(file="./20190807vs2_v3update_newganoidscombined.rds")
Sams_obj[["cell_type"]] <- Idents(object = Sams_obj)
Sams_obj$cell_type_stim <- paste(Sams_obj$cell_type,"_",Sams_obj$stim,sep="")
Idents(object = Sams_obj) <- "cell_type_stim"
Sams_avg_exp <- AverageExpression(Sams_obj, assay="SCT")
Sams_avg_exp_sct <- as.data.frame(Sams_avg_exp$SCT)
#Sams_avg_exp_sct <- log2(Sams_avg_exp_sct+1)

Sams_avg_exp_sct$gene <- rownames(Sams_avg_exp_sct)
# convert gene symbol to Ens for single cell average expression data
list_gene <- as.character(Sams_avg_exp_sct$gene)
ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")
query_ensembl<-getBM(attributes=c('ensembl_gene_id','hgnc_symbol','gene_biotype'), mart = ensembl, values=list_gene)

query_ensembl_pc <- subset(query_ensembl, query_ensembl$gene_biotype=="protein_coding", select = 1:2)

Sams_avg_exp_sct_ens <- merge(Sams_avg_exp_sct,query_ensembl_pc,by.x="gene",by.y="hgnc_symbol")
rownames(Sams_avg_exp_sct_ens) <- Sams_avg_exp_sct_ens$ensembl_gene_id
Sams_avg_exp_sct_ens <- subset(Sams_avg_exp_sct_ens, select=-c(gene,ensembl_gene_id))
rm(Sams_avg_exp_sct)
```

+ Remove low expressed genes and only keep protein coding genes in the brainspan RPKM matrix

```{r}
#brainspan_original <- read.table(file="./brainspan_processed_extended_prenatal.txt")
# Remove low expressed genes from brain span RPKM data
list_gene <- as.character(rownames(brainspan_original))
ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")
query_ensembl<-getBM(attributes=c('ensembl_gene_id','hgnc_symbol','gene_biotype'), mart = ensembl, values=list_gene)

query_ensembl_pc <- subset(query_ensembl, query_ensembl$gene_biotype=="protein_coding", select = 1:3)
brainspan_original$gene <- rownames(brainspan_original)
brainspan_original_pc <- merge(brainspan_original,query_ensembl_pc,by.x="gene",by.y="ensembl_gene_id")
brainspan_original_pc <- subset(brainspan_original_pc, select=-c(hgnc_symbol,gene_biotype))

brainspan_original_pc = brainspan_original_pc %>%
                 group_by(gene) %>%
                summarise_all(mean) 
brainspan_original_pc <- as.data.frame(brainspan_original_pc)

rownames(brainspan_original_pc) <- brainspan_original_pc$gene


brainspan_original_pc <- subset(brainspan_original_pc, select=-c(gene))


#cat("Number of genes and samples: ", dim(brainspan_original_pc), fill=T)
#cat("Number of genes with no read (estimated TPM) in any sample: ", sum(rowSums(brainspan_original_pc) == 0), fill=T)
#cat("Number of genes with exactly a count of 1 in a single sample (genes with row sum of 1):", sum(rowSums(brainspan_original_pc) == 1), fill=T)
# Filtering all genes with o counts across all samples
#keep_feature <- rowSums(brainspan_original_pc > 0) > 0
#brainspan_original_pc <- brainspan_original_pc[keep_feature, ]

# at least 4 samples with a TPM 1 or higher 
#keep_feature <- rowSums(brainspan_original_pc >= 1) >= 3
#brainspan_original_pc <- brainspan_original_pc[keep_feature, ]

#cat("Number of genes and samples after filtering of genes based on a RPKM >= 1 in atleast 3 samples : ", dim(brainspan_original_pc), fill=T)

#brainspan_original_pc <- log2(brainspan_original_pc+1)
```

+ Keep only the common genes between the brainspan and the single cell organoid data

```{r}
#brainspan_metadata_short <- brainspan_metadata_1[,c(4,3,2)]
brainspan_metadata_short <- brainspan_metadata[,c(11,10,9)]
setnames(brainspan_metadata_short,c("brain_region_short","dev_period"), c("cell_type","condition"))

#setnames(brainspan_metadata_short,c("brain_region_short","maturity_stage"), c("cell_type","condition"))
brainspan_metadata_short$Study <- "brainspan"
rownames(brainspan_metadata_short) <- brainspan_metadata_short$Sample_ID
#brainspan_processed <- log2(brainspan_processed+1)



common_genes <- intersect(rownames(brainspan_original_pc), rownames(Sams_avg_exp_sct_ens))

# filter brain span data to common genes
#brainspan_processed$gene <- rownames(brainspan_processed)
#brainspan_processed_common <- brainspan_processed %>% filter(gene %in% common_genes)
#rownames(brainspan_processed_common) <- brainspan_processed_common$gene
#brainspan_processed_common <- subset(brainspan_processed_common, select=-c(gene))

brainspan_original_pc$gene <- rownames(brainspan_original_pc)
brainspan_original_common <- brainspan_original_pc %>% filter(gene %in% common_genes)
rownames(brainspan_original_common) <- brainspan_original_common$gene
brainspan_original_common <- subset(brainspan_original_common, select=-c(gene))



# Filter single cell average expresison object to only the common genes
Sams_avg_exp_sct_ens$gene <- rownames(Sams_avg_exp_sct_ens)
Sams_avg_exp_sct_ens_common <- Sams_avg_exp_sct_ens %>% filter(gene %in% common_genes)
rm(Sams_avg_exp_sct_ens)
rownames(Sams_avg_exp_sct_ens_common) <- Sams_avg_exp_sct_ens_common$gene
Sams_avg_exp_sct_ens_common <- subset(Sams_avg_exp_sct_ens_common, select=-c(gene))

# Create metadata for the single cell Averaged object
Sams_avg_exp <- AverageExpression(Sams_obj, assay="SCT", return.seurat = T)
Sams_avg_exp_metadata <- Sams_avg_exp@meta.data
rm(Sams_avg_exp)
Sams_avg_exp_metadata$stim <- rownames(Sams_avg_exp_metadata)
Sams_avg_exp_metadata <- Sams_avg_exp_metadata %>% separate(stim, sep="_",c("A","B"))
setnames(Sams_avg_exp_metadata, c("A","B"), c("cell_type","condition"))
Sams_avg_exp_metadata$Sample_ID <- rownames(Sams_avg_exp_metadata)

Sams_avg_exp_metadata_short <- Sams_avg_exp_metadata[,c(6,4,5)]
Sams_avg_exp_metadata_short$Study <- "Nayler_Organoid"



```

+ combine Brainspan and Nayler Average expression
+ Remove batch effect ysing ComBat

```{r}
combined_data <- cbind(brainspan_original_common,Sams_avg_exp_sct_ens_common)
combined_data <- log2(combined_data +1)
combined_metadata <- rbind(brainspan_metadata_short,Sams_avg_exp_metadata_short)
rownames(combined_metadata) <- combined_metadata$Sample_ID
combined_metadata$Study <- as.factor(combined_metadata$Study)

library(RColorBrewer)
colB1 <- Vector2Colour(combined_metadata$Sample_ID)
colB2 <- Vector2Colour(combined_metadata$cell_type)
colB3 <- Vector2Colour(combined_metadata$Study)
#colB4 <- Vector2Colour(combined_metadata$Study)

coloresB <- c("colB1","colB2","colB3")
nomsB <- c( "Sample_ID","cell_type","Study")


combat_combined_data <- ComBat(as.matrix(combined_data), batch= combined_metadata$Study, par.prior = T, prior.plots = F)
combat_brainspan <- as.data.frame(combat_combined_data[,1:107])
combat_Sam <- as.data.frame(combat_combined_data[,108:131])

# Run Limma
limma_combined_data <- limma::removeBatchEffect(as.matrix(combined_data), batch=combined_metadata$Study)
limma_brainspan <- limma_combined_data[,1:107]
limma_Sam <- limma_combined_data[,108:131]
```

+ Check density plots of non-corrected combined data to check in need to use corrected data for combined PCA or clustering
+ the two distirubtion are very different

```{r density_1, echo=FALSE, include=T}
#### Check densities of combined data before batch correction
for(j in c(1:length(coloresB))){
  plot(density(combined_data[, 1]), col = get(coloresB[j])[1], ylim = c(0, 1.00), 
       lwd = 2, main = "", ylab = "Expression level percentage")
  for (i in c(2:dim(combined_data)[2])){
    lines(density(combined_data[, i]), col = get(coloresB[j])[i], lwd = 2)
  }
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .8, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 2, xpd = TRUE)
}
```
+ Check combat corrected data density plots
```{r density_1, echo=FALSE, include=T}
#### Check densities of combined data before batch correction
for(j in c(1:length(coloresB))){
  plot(density(limma_combined_data[, 1]), col = get(coloresB[j])[1], ylim = c(0, 1.00), 
       lwd = 2, main = "", ylab = "Expression level percentage")
  for (i in c(2:dim(limma_combined_data)[2])){
    lines(density(limma_combined_data[, i]), col = get(coloresB[j])[i], lwd = 2)
  }
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .8, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 5, xpd = TRUE)
}
```

# BrainSpan PCA on combat corrected data 
+ did not work on my version of the data , but did on Cynthias version

```{r, brainspan_pca, fig.width= 6, fig.height=3}
#limma_brainspan <- limma_combined_data[,1:107]

#brainspan_original_common <- log2(brainspan_original_common+1)
pc_brainspan <- prcomp(t((limma_brainspan)))
brainspan_metadata_short$pc1 <- pc_brainspan$x[, 1]
brainspan_metadata_short$pc2 <-  pc_brainspan$x[, 2]
  brainspan_metadata_short$pc3 <- pc_brainspan$x[, 3]
  brainspan_metadata_short$pc4 <- pc_brainspan$x[, 4]
 brainspan_metadata_short$pc5 <- pc_brainspan$x[, 5]
 brainspan_metadata_short$pc6 <- pc_brainspan$x[, 6]
  pve_pc_brainspan <- summary(pc_brainspan)$importance[2, ]
  
  #percent_var <- round( signif((pve[2]) * 100, 4), 2)
library(RColorBrewer)
colourCount = length(unique(brainspan_metadata_short$condition))
#colourCount2= length(unique(plotdata$Batch))
getPalette = colorRampPalette(brewer.pal(11, "Set2"))
  
  


cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan)[1])
p <- ggplot(data = brainspan_metadata_short, aes(x=pc1, y=pc2, color= condition, shape=cell_type))

p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_short$cell_type))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan[1]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC2 (",signif((pve_pc_brainspan[2]) * 100, 4), "%)")) +xlim(-100,120)
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p
#ggsave(p, filename = "Brainspan_maturity_axis_ipsc1.tiff", path = "./output/Brainspan", dpi = 300)

cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan)[1])
p <- ggplot(data = brainspan_metadata_short, aes(x=pc2, y=pc3, colour= condition, shape =cell_type))
p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_short$cell_type))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC3 (",signif((pve_pc_brainspan[3]) * 100, 4), "%)"))
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p




```


```{r predict_ipsc_pca_2, include=FALSE}
# Predict PCA loadings for ipsc data based on Nigra PCA space

pred_sam_organoid_brainspan <- predict(pc_brainspan, newdata=(t(limma_Sam)))
pred_sam_organoid_brainspan <- as.data.frame(pred_sam_organoid_brainspan)

Sams_avg_exp_metadata_short$pc1 <- pred_sam_organoid_brainspan$PC1
Sams_avg_exp_metadata_short$pc2 <- pred_sam_organoid_brainspan$PC2
Sams_avg_exp_metadata_short$pc3 <- pred_sam_organoid_brainspan$PC3
Sams_avg_exp_metadata_short$pc4 <- pred_sam_organoid_brainspan$PC4

combined_metadata <- rbind(brainspan_metadata_short[,c(1:8)], Sams_avg_exp_metadata_short[,c(1:8)])
```

# plot ipsc dataste1 projected on brainspan PCA space
```{r project_ipsc_pca, fig.height=3, fig.width=5}
p <- ggplot(data = combined_metadata, aes(x=pc1, y=pc2, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan[1]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p

p <- ggplot(data = combined_metadata, aes(x=pc2, y=pc3, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC3 (", signif((pve_pc_brainspan[3]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p

#ggsave(p, filename = "ipsc_dataset1_Brainspan_PCA_projeciton.tiff", path = "./output/Brainspan", dpi = 300)

```



# BrainSpan PCA on combat corrected data for Prenatala nd infant samples only
+ did not work on my version of the data , but did on Cynthias version
```{r, brainspan_pca, fig.width= 6, fig.height=3}
#limma_brainspan <- limma_combined_data[,1:107]

#limma_brainspan_infancy <- limma_brainspan[,1:59]
brainspan_metadata_infancy <- brainspan_metadata_short[1:59,]

combat_brainspan_infancy <- combat_brainspan[,1:59]
#brainspan_original_common <- log2(brainspan_original_common+1)
pc_brainspan_infancy <- prcomp(t((limma_brainspan_infancy)))
brainspan_metadata_infancy$pc1 <- pc_brainspan_infancy$x[, 1]
brainspan_metadata_infancy$pc2 <-  pc_brainspan_infancy$x[, 2]
  brainspan_metadata_infancy$pc3 <- pc_brainspan_infancy$x[, 3]
  brainspan_metadata_infancy$pc4 <- pc_brainspan_infancy$x[, 4]
 brainspan_metadata_infancy$pc5 <- pc_brainspan_infancy$x[, 5]
 brainspan_metadata_infancy$pc6 <- pc_brainspan_infancy$x[, 6]
  pve_pc_brainspan_infancy <- summary(pc_brainspan_infancy)$importance[2, ]
  
  #percent_var <- round( signif((pve[2]) * 100, 4), 2)
library(RColorBrewer)
colourCount = length(unique(brainspan_metadata_infancy$condition))
#colourCount2= length(unique(plotdata$Batch))
getPalette = colorRampPalette(brewer.pal(11, "Set2"))
  
  


cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan_infancy)[1])
p <- ggplot(data = brainspan_metadata_infancy, aes(x=pc1, y=pc2, color= condition, shape=cell_type))

p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_infancy$cell_type))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan_infancy[1]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC2 (",signif((pve_pc_brainspan_infancy[2]) * 100, 4), "%)")) +xlim(-100,120)
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p
#ggsave(p, filename = "Brainspan_maturity_axis_ipsc1.tiff", path = "./output/Brainspan", dpi = 300)

cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan_infancy)[1])
p <- ggplot(data = brainspan_metadata_infancy, aes(x=pc2, y=pc3, colour= condition, shape =cell_type))
p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_infancy$cell_type))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan_infancy[2]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC3 (",signif((pve_pc_brainspan_infancy[3]) * 100, 4), "%)"))
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p




```


```{r predict_ipsc_pca_2, include=FALSE}
# Predict PCA loadings for ipsc data based on Nigra PCA space

pred_sam_organoid_brainspan <- predict(pc_brainspan_infancy, newdata=(t(limma_Sam)))
pred_sam_organoid_brainspan <- as.data.frame(pred_sam_organoid_brainspan)

Sams_avg_exp_metadata_short$pc1 <- pred_sam_organoid_brainspan$PC1
Sams_avg_exp_metadata_short$pc2 <- pred_sam_organoid_brainspan$PC2
Sams_avg_exp_metadata_short$pc3 <- pred_sam_organoid_brainspan$PC3
Sams_avg_exp_metadata_short$pc4 <- pred_sam_organoid_brainspan$PC4

combined_metadata <- rbind(brainspan_metadata_infancy[,c(1:8)], Sams_avg_exp_metadata_short[,c(1:8)])
```

# plot ipsc dataste1 projected on brainspan PCA space
```{r project_ipsc_pca, fig.height=3, fig.width=5}
p <- ggplot(data = combined_metadata, aes(x=pc1, y=pc2, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan[1]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p
ggsave(p, filename = "Sam_organoid_Brainspan_PCA_projeciton.tiff", path = "./", dpi = 300)
p <- ggplot(data = combined_metadata, aes(x=pc2, y=pc3, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC3 (", signif((pve_pc_brainspan[3]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p

#ggsave(p, filename = "ipsc_dataset1_Brainspan_PCA_projeciton.tiff", path = "./output/Brainspan", dpi = 300)

```

# Sams Data PCA
```{r}
#Sams_avg_exp_sct_ens_common <- log2(Sams_avg_exp_sct_ens_common+1)
pc_organoid <- prcomp(t((Sams_avg_exp_sct_ens_common)))
Sams_avg_exp_metadata_short$pc1 <- pc_organoid$x[, 1]
Sams_avg_exp_metadata_short$pc2 <-  pc_organoid$x[, 2]
  Sams_avg_exp_metadata_short$pc3 <- pc_organoid$x[, 3]
  Sams_avg_exp_metadata_short$pc4 <- pc_organoid$x[, 4]
Sams_avg_exp_metadata_short$pc5 <- pc_organoid$x[, 5]
Sams_avg_exp_metadata_short$pc6 <-pc_organoid$x[, 6]
  pve_pc_organoid <- summary(pc_organoid)$importance[2, ]
  
  #percent_var <- round( signif((pve[2]) * 100, 4), 2)
library(RColorBrewer)
colourCount = length(unique(Sams_avg_exp_metadata_short$cell_type))
#colourCount2= length(unique(plotdata$Batch))
getPalette = colorRampPalette(brewer.pal(11, "Set2"))
  
  


cat("Pseudobulk Organoid data: ", dim(Sams_avg_exp_sct_ens_common)[1])
p <- ggplot(data = Sams_avg_exp_metadata_short, aes(x=pc1, y=pc2, color= cell_type, shape=condition))

p <- p + geom_point(alpha = 0.8, size=6, stroke=2)
#p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_short$cell_type))
p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_organoid[1]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC2 (",signif((pve_pc_organoid[2]) * 100, 4), "%)")) +xlim(-100,120)
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p


cat("Pseudobulk Organoid data: ", dim(Sams_avg_exp_sct_ens_common)[1])
p <- ggplot(data = Sams_avg_exp_metadata_short, aes(x=pc2, y=pc3, color= cell_type, shape=condition))

p <- p + geom_point(alpha = 0.8, size=6, stroke=2)
#p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_short$cell_type))
p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_organoid[2]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC3 (",signif((pve_pc_organoid[3]) * 100, 4), "%)")) +xlim(-100,120)
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p
```




```{r}

### iPSC and Nigra samples clustering 
 
# + Similarity between expression profiles measured as the Ward clustering from the euclidean distance of (1 - rho). Where rho is the spearman correlation between each pair of samples.
rho <- cor(combat_combined_data, method = "spearman")
```



```{r echo=FALSE, fig.height=4, fig.width=8, include=T}
#+ The spearman correlation range from `r signif(min(rho), 3)` to 
#`r signif(max(rho[upper.tri(rho, diag = FALSE)]), 3)`.
tiff("./Averaged_organoid_populations_brainspan_clustering_cynthia_version.tiff", res=300, height=4, width=9, units = "in")
par(mar = c(6, 5, 4, 6), mfrow = c(1, 1))
for(j in c(1:length(coloresB))){
  d1 <- as.dendrogram(hclust(as.dist(1 - rho), method = "ward.D2"))
  dendextend::labels_colors(d1) <- get(coloresB[j])[match(labels(d1), combined_metadata$Sample_ID)]
  dendextend::labels_cex(d1) <- 0.3
  plot(d1, ylab = "Distance (1 - rho)", main = nomsB[j],cex.axis =0.5)
  rm(d1)
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .6, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 4, xpd = TRUE, inset = -.05)
}
rm(rho, j)
#par(mfrow = c(1, 1), mar = c(0,0,0,0))

```


# use ranking and eucledian distance method
+ use non log values for expression matrix
+ this did not work , batch effect was still evident

```{r}
combined_data_rank <- as.data.frame(apply(-combined_data,2, rank, ties.method="min"))

```

```{r echo=FALSE, fig.height=4, fig.width=8, include=T}
#+ The spearman correlation range from `r signif(min(rho), 3)` to 
#`r signif(max(rho[upper.tri(rho, diag = FALSE)]), 3)`.
tiff("./Averaged_organoid_populations_brainspan_clustering_cynthia_version_method.tiff", res=300, height=4, width=9, units = "in")
par(mar = c(6, 5, 4, 6), mfrow = c(1, 1))
for(j in c(1:length(coloresB))){
  d1 <- as.dendrogram(hclust(dist(as.matrix(t(combined_data_rank))), method = "ward.D2"))
  dendextend::labels_colors(d1) <- get(coloresB[j])[match(labels(d1), combined_metadata$Sample_ID)]
  dendextend::labels_cex(d1) <- 0.3
  plot(d1, ylab = "Euclidean distance", main = nomsB[j],cex.axis =0.5)
  rm(d1)
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .6, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 4, xpd = TRUE, inset = -.05)
}
rm(rho, j)
#par(mfrow = c(1, 1), mar = c(0,0,0,0))

```
+ Clustering with expresison matrix batch corrected by limma::removeBatcheffect

```{r}

### iPSC and Nigra samples clustering 
 
# + Similarity between expression profiles measured as the Ward clustering from the euclidean distance of (1 - rho). Where rho is the spearman correlation between each pair of samples.
rho <- cor(limma_combined_data, method = "spearman")
```



```{r echo=FALSE, fig.height=4, fig.width=8, include=T}
#+ The spearman correlation range from `r signif(min(rho), 3)` to 
#`r signif(max(rho[upper.tri(rho, diag = FALSE)]), 3)`.
tiff("./Averaged_organoid_populations_brainspan_clustering_cynthia_version_limma.tiff", res=300, height=4, width=9, units = "in")
par(mar = c(6, 5, 4, 6), mfrow = c(1, 1))
for(j in c(1:length(coloresB))){
  d1 <- as.dendrogram(hclust(as.dist(1 - rho), method = "ward.D2"))
  dendextend::labels_colors(d1) <- get(coloresB[j])[match(labels(d1), combined_metadata$Sample_ID)]
  dendextend::labels_cex(d1) <- 0.3
  plot(d1, ylab = "Distance (1 - rho)", main = nomsB[j],cex.axis =0.5)
  rm(d1)
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .6, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 4, xpd = TRUE, inset = -.05)
}
rm(rho, j)
#par(mfrow = c(1, 1), mar = c(0,0,0,0))

```


+ Clustering with expresison matrix batch corrected by limma::removeBatcheffect

```{r}

### iPSC and Nigra samples clustering 
 
# + Similarity between expression profiles measured as the Ward clustering from the euclidean distance of (1 - rho). Where rho is the spearman correlation between each pair of samples.
rho <- cor(limma_combined_data, method = "spearman")
```



```{r echo=FALSE, fig.height=4, fig.width=8, include=T}
#+ The spearman correlation range from `r signif(min(rho), 3)` to 
#`r signif(max(rho[upper.tri(rho, diag = FALSE)]), 3)`.
tiff("./Averaged_organoid_populations_brainspan_clustering_my_version_limma.tiff", res=300, height=4, width=9, units = "in")
par(mar = c(6, 5, 4, 6), mfrow = c(1, 1))
for(j in c(1:length(coloresB))){
  d1 <- as.dendrogram(hclust(as.dist(1 - rho), method = "ward.D2"))
  dendextend::labels_colors(d1) <- get(coloresB[j])[match(labels(d1), combined_metadata$Sample_ID)]
  dendextend::labels_cex(d1) <- 0.3
  plot(d1, ylab = "Distance (1 - rho)", main = nomsB[j],cex.axis =0.5)
  rm(d1)
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .6, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 4, xpd = TRUE, inset = -.05)
}
rm(rho, j)
#par(mfrow = c(1, 1), mar = c(0,0,0,0))

```

+ Clustering with expresison matrix batch corrected by ComBat

```{r}

### iPSC and Nigra samples clustering 
 
# + Similarity between expression profiles measured as the Ward clustering from the euclidean distance of (1 - rho). Where rho is the spearman correlation between each pair of samples.
rho <- cor(combat_combined_data, method = "spearman")
```



```{r echo=FALSE, fig.height=4, fig.width=8, include=T}
#+ The spearman correlation range from `r signif(min(rho), 3)` to 
#`r signif(max(rho[upper.tri(rho, diag = FALSE)]), 3)`.
#tiff("./Averaged_organoid_populations_brainspan_clustering_my_version_ComBat.tiff", res=300, height=4, width=9, units = "in")
par(mar = c(6, 5, 4, 6), mfrow = c(1, 1))
for(j in c(1:length(coloresB))){
  d1 <- as.dendrogram(hclust(as.dist(1 - rho), method = "ward.D2"))
  dendextend::labels_colors(d1) <- get(coloresB[j])[match(labels(d1), combined_metadata$Sample_ID)]
  dendextend::labels_cex(d1) <- 0.3
  plot(d1, ylab = "Distance (1 - rho)", main = nomsB[j],cex.axis =0.5)
  rm(d1)
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .6, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 4, xpd = TRUE, inset = -.05)
}
rm(rho, j)
#par(mfrow = c(1, 1), mar = c(0,0,0,0))

```




# Read in Sams Seurat object
+ Sum genes across CTRL and Matrigel cells to get pseudobulk samples


```{r sum_pseudobulk, echo=FALSE}
Sams_obj <- readRDS(file="./20190807vs2_v3update_newganoidscombined.rds")
Sams_obj[["cell_type"]] <- Idents(object = Sams_obj)
Sams_obj$cell_type_stim <- paste(Sams_obj$cell_type,"_",Sams_obj$stim,sep="")
Idents(object = Sams_obj) <- "stim"
Sam_ctrl <- subset(Sams_obj, subset=stim=="CTRL")
Sam_stim <- subset(Sams_obj, subset=stim=="STIM")

sc.data_ctrl <- data.frame(symbol=Sam_ctrl@assays$SCT@counts@Dimnames[[1]],ctrl=rowSums(Sam_ctrl@assays$SCT@counts))
sc.data_stim <- data.frame(symbol=Sam_stim@assays$SCT@counts@Dimnames[[1]],stim=rowSums(Sam_stim@assays$SCT@counts))


#Sams_avg_exp_sct <- log2(Sams_avg_exp_sct+1)

sc.data_treatment <- cbind(sc.data_ctrl,sc.data_stim)
sc.data_treatment <- sc.data_treatment[,-3]

rm(sc.data_ctrl,sc.data_stim)
# convert gene symbol to Ens for single cell average expression data
list_gene <- as.character(sc.data_treatment$symbol)
ensembl = useEnsembl(biomart="ensembl", dataset="hsapiens_gene_ensembl")
query_ensembl<-getBM(attributes=c('ensembl_gene_id','hgnc_symbol','gene_biotype'), mart = ensembl, values=list_gene)

query_ensembl_pc <- subset(query_ensembl, query_ensembl$gene_biotype=="protein_coding", select = 1:2)

sc.data_treatment_ens <- merge(sc.data_treatment,query_ensembl_pc,by.x="symbol",by.y="hgnc_symbol")

#sc.data_treatment_ens_1 <- aggregate(sc.data_treatment_ens[,2:3], by= list(sc.data_treatment_ens$ensembl_gene_id), FUN = mean)

rownames(sc.data_treatment_ens) <- sc.data_treatment_ens$ensembl_gene_id


sc.data_treatment_ens <- subset(sc.data_treatment_ens , select=-c(symbol,ensembl_gene_id))
rm(sc.data_treatment)

# filter genes that are zero across both stim and ctrl
keep_feature <- rowSums(sc.data_treatment_ens > 0) > 0
sc.data_treatment_ens <- sc.data_treatment_ens[keep_feature, ]
```

+ Keep only the common genes between the brainspan and the single cell organoid data

```{r}
#brainspan_metadata_short <- brainspan_metadata_1[,c(4,3,2)]
brainspan_metadata_short <- brainspan_metadata[,c(11,10,9)]
setnames(brainspan_metadata_short,c("brain_region_short","dev_period"), c("Tissue","condition"))

#setnames(brainspan_metadata_short,c("brain_region_short","maturity_stage"), c("cell_type","condition"))
brainspan_metadata_short$Study <- "Brainspan"
rownames(brainspan_metadata_short) <- brainspan_metadata_short$Sample_ID
#brainspan_processed <- log2(brainspan_processed+1)



common_genes <- intersect(rownames(brainspan_original_pc), rownames(sc.data_treatment_ens))

# filter brain span data to common genes
#brainspan_processed$gene <- rownames(brainspan_processed)
#brainspan_processed_common <- brainspan_processed %>% filter(gene %in% common_genes)
#rownames(brainspan_processed_common) <- brainspan_processed_common$gene
#brainspan_processed_common <- subset(brainspan_processed_common, select=-c(gene))

brainspan_original_pc$gene <- rownames(brainspan_original_pc)
brainspan_original_common <- brainspan_original_pc %>% filter(gene %in% common_genes)
rownames(brainspan_original_common) <- brainspan_original_common$gene
brainspan_original_common <- subset(brainspan_original_common, select=-c(gene))



# Filter single cell average expresison object to only the common genes
sc.data_treatment_ens$gene <- rownames(sc.data_treatment_ens)
sc.data_treatment_ens_common <- sc.data_treatment_ens %>% filter(gene %in% common_genes)
rm(sc.data_treatment_ens)
rownames(sc.data_treatment_ens_common) <- sc.data_treatment_ens_common$gene
sc.data_treatment_ens_common <- subset(sc.data_treatment_ens_common, select=-c(gene))


# Create metadata for the single cell summed by treatment object
Sams_treatment_metdata <- as.data.frame(colnames(sc.data_treatment_ens_common))

Sample_ID <- as.character(c("CB_Organoid_CTRL","CB_Organoid_STIM"))

Sams_treatment_metdata$Sample_ID <- factor(Sample_ID, levels = c("CB_Organoid_CTRL","CB_Organoid_STIM"))
Sams_treatment_metdata$Study <- "Nayler_Organoid"
Sams_treatment_metdata$Tissue <- "Cerebellum"
colnames(sc.data_treatment_ens_common) <- Sams_treatment_metdata$Sample_ID
setnames(Sams_treatment_metdata, c("colnames(sc.data_treatment_ens_common)"), ("condition"))


rownames(Sams_treatment_metdata) <- Sams_treatment_metdata$Sample_ID

Sams_treatment_metdata <- Sams_treatment_metdata[,c(2,4,1,3)]

```
+ combine Brainspan and Nayler summed treatment expression
+ Remove batch effect ysing ComBat
```{r}
combined_data <- cbind(brainspan_original_common,sc.data_treatment_ens_common)
combined_data <- log(combined_data +1)
combined_metadata <- rbind(brainspan_metadata_short,Sams_treatment_metdata)
rownames(combined_metadata) <- combined_metadata$Sample_ID
combined_metadata$Study <- as.factor(combined_metadata$Study)

library(RColorBrewer)
colB1 <- Vector2Colour(combined_metadata$Sample_ID)
colB2 <- Vector2Colour(combined_metadata$Tissue)
colB3 <- Vector2Colour(combined_metadata$Study)
#colB4 <- Vector2Colour(combined_metadata$Study)

coloresB <- c("colB1","colB2","colB3")
nomsB <- c( "Sample_ID","Tissue","Study")


combat_combined_data <- ComBat(as.matrix(combined_data), batch= combined_metadata$Study, par.prior = T, prior.plots = F)
combat_brainspan <- as.data.frame(combat_combined_data[,1:107])
combat_Sam <- as.data.frame(combat_combined_data[,108:109])

# Run Limma
limma_combined_data <- limma::removeBatchEffect(as.matrix(combined_data), batch=combined_metadata$Study)
limma_brainspan <- limma_combined_data[,1:107]
limma_Sam <- limma_combined_data[,108:109]
```

# BrainSpan PCA on combat corrected data 

```{r, brainspan_pca, fig.width= 6, fig.height=3}
#limma_brainspan <- limma_combined_data[,1:107]

#brainspan_original_common <- log2(brainspan_original_common+1)
pc_brainspan <- prcomp(t((combat_brainspan)))
brainspan_metadata_short$pc1 <- pc_brainspan$x[, 1]
brainspan_metadata_short$pc2 <-  pc_brainspan$x[, 2]
  brainspan_metadata_short$pc3 <- pc_brainspan$x[, 3]
  brainspan_metadata_short$pc4 <- pc_brainspan$x[, 4]
 brainspan_metadata_short$pc5 <- pc_brainspan$x[, 5]
 brainspan_metadata_short$pc6 <- pc_brainspan$x[, 6]
  pve_pc_brainspan <- summary(pc_brainspan)$importance[2, ]
  
  #percent_var <- round( signif((pve[2]) * 100, 4), 2)
library(RColorBrewer)
colourCount = length(unique(brainspan_metadata_short$condition))
#colourCount2= length(unique(plotdata$Batch))
getPalette = colorRampPalette(brewer.pal(11, "Set2"))
  
  


cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan)[1])
p <- ggplot(data = brainspan_metadata_short, aes(x=pc1, y=pc2, color= condition, shape=Tissue))

p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_short$Tissue))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan[1]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC2 (",signif((pve_pc_brainspan[2]) * 100, 4), "%)")) +xlim(-100,120)
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p
#ggsave(p, filename = "Brainspan_maturity_axis_ipsc1.tiff", path = "./output/Brainspan", dpi = 300)

cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan)[1])
p <- ggplot(data = brainspan_metadata_short, aes(x=pc2, y=pc3, colour= condition, shape =Tissue))
p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_short$Tissue))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC3 (",signif((pve_pc_brainspan[3]) * 100, 4), "%)"))
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p




```


```{r predict_ipsc_pca_2, include=FALSE}
# Predict PCA loadings for ipsc data based on Nigra PCA space

pred_sam_organoid_brainspan <- predict(pc_brainspan, newdata=(t(combat_Sam)))
pred_sam_organoid_brainspan <- as.data.frame(pred_sam_organoid_brainspan)

Sams_treatment_metdata$pc1 <- pred_sam_organoid_brainspan$PC1
Sams_treatment_metdata$pc2 <- pred_sam_organoid_brainspan$PC2
Sams_treatment_metdata$pc3 <- pred_sam_organoid_brainspan$PC3
Sams_treatment_metdata$pc4 <- pred_sam_organoid_brainspan$PC4

combined_metadata <- rbind(brainspan_metadata_short[,c(1:8)], Sams_treatment_metdata[,c(1:8)])
```

# plot ipsc dataste1 projected on brainspan PCA space
```{r project_ipsc_pca, fig.height=3, fig.width=5}
p <- ggplot(data = combined_metadata, aes(x=pc1, y=pc2, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan[1]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p

p <- ggplot(data = combined_metadata, aes(x=pc2, y=pc3, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC3 (", signif((pve_pc_brainspan[3]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p

#ggsave(p, filename = "ipsc_dataset1_Brainspan_PCA_projeciton.tiff", path = "./output/Brainspan", dpi = 300)

```



# BrainSpan PCA on combat corrected data for Prenatala nd infant samples only
+ did not work on my version of the data , but did on Cynthias version

```{r, brainspan_pca, fig.width= 6, fig.height=3}
#limma_brainspan <- limma_combined_data[,1:107]

#limma_brainspan_infancy <- limma_brainspan[,1:59]
brainspan_metadata_infancy <- brainspan_metadata_short[1:59,]

combat_brainspan_infancy <- combat_brainspan[,1:59]
#brainspan_original_common <- log2(brainspan_original_common+1)
pc_brainspan_infancy <- prcomp(t((combat_brainspan_infancy)))
brainspan_metadata_infancy$pc1 <- pc_brainspan_infancy$x[, 1]
brainspan_metadata_infancy$pc2 <-  pc_brainspan_infancy$x[, 2]
  brainspan_metadata_infancy$pc3 <- pc_brainspan_infancy$x[, 3]
  brainspan_metadata_infancy$pc4 <- pc_brainspan_infancy$x[, 4]
 brainspan_metadata_infancy$pc5 <- pc_brainspan_infancy$x[, 5]
 brainspan_metadata_infancy$pc6 <- pc_brainspan_infancy$x[, 6]
  pve_pc_brainspan_infancy <- summary(pc_brainspan_infancy)$importance[2, ]
  
  #percent_var <- round( signif((pve[2]) * 100, 4), 2)
library(RColorBrewer)
colourCount = length(unique(brainspan_metadata_infancy$condition))
#colourCount2= length(unique(plotdata$Batch))
getPalette = colorRampPalette(brewer.pal(11, "Set2"))
  
  


cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan_infancy)[1])
p <- ggplot(data = brainspan_metadata_infancy, aes(x=pc1, y=pc2, color= condition, shape=Tissue))

p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_infancy$Tissue))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan_infancy[1]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC2 (",signif((pve_pc_brainspan_infancy[2]) * 100, 4), "%)")) +xlim(-100,120)
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p
#ggsave(p, filename = "Brainspan_maturity_axis_ipsc1.tiff", path = "./output/Brainspan", dpi = 300)

cat("Limma corrected brainspan RPKM data: ", dim(limma_brainspan_infancy)[1])
p <- ggplot(data = brainspan_metadata_infancy, aes(x=pc2, y=pc3, colour= condition, shape =Tissue))
p <- p + geom_point(alpha = 0.4, size=6, stroke=2)
p <- p + scale_shape_manual(values=1:nlevels(brainspan_metadata_infancy$Tissue))
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan_infancy[2]) * 100, 4), "%)"))
p <- p + ylab(paste0("PC3 (",signif((pve_pc_brainspan_infancy[3]) * 100, 4), "%)"))
#p <- p + geom_text_repel(point.padding = NA, size=4)
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
p




```


```{r predict_ipsc_pca_2, include=FALSE}
# Predict PCA loadings for ipsc data based on Nigra PCA space

pred_sam_organoid_brainspan <- predict(pc_brainspan_infancy, newdata=(t(combat_Sam)))
pred_sam_organoid_brainspan <- as.data.frame(pred_sam_organoid_brainspan)

Sams_treatment_metdata$pc1 <- pred_sam_organoid_brainspan$PC1
Sams_treatment_metdata$pc2 <- pred_sam_organoid_brainspan$PC2
Sams_treatment_metdata$pc3 <- pred_sam_organoid_brainspan$PC3
Sams_treatment_metdata$pc4 <- pred_sam_organoid_brainspan$PC4

combined_metadata <- rbind(brainspan_metadata_infancy[,c(1:8)], Sams_treatment_metdata[,c(1:8)])
```

# plot ipsc dataste1 projected on brainspan PCA space
```{r project_ipsc_pca, fig.height=3, fig.width=5}
p <- ggplot(data = combined_metadata, aes(x=pc1, y=pc2, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC1 (", signif((pve_pc_brainspan[1]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p
ggsave(p, filename = "Sam_organoid_treatment_Brainspan_PCA_projeciton_combat.tiff", path = "./", dpi = 300)
p <- ggplot(data = combined_metadata, aes(x=pc2, y=pc3, color= condition, shape=Study))
p <- p + geom_point(alpha = 0.6, size=8)
#p <- p + coord_flip()
#p <- p + scale_colour_manual(values = getPalette(colourCount))
p <- p + ylab(paste0("PC3 (", signif((pve_pc_brainspan[3]) * 100, 4), "%)"))
p <- p + xlab(paste0("PC2 (", signif((pve_pc_brainspan[2]) * 100, 4), "%)")) 
p <- p + geom_hline(yintercept=0, linetype="dashed", color = "gray")
p <- p + geom_vline(xintercept=0, linetype="dashed", color = "gray")
p <- p + guides(colour = guide_legend(override.aes = list(alpha=1)))
#p <- p + theme(legend.position = "none") 
#p <- p + geom_text_repel(point.padding = NA, size=5) + ggtitle("Projection of ipsc dataset 1 on Brainspan maturity PCA axis")
p

#ggsave(p, filename = "ipsc_dataset1_Brainspan_PCA_projeciton.tiff", path = "./output/Brainspan", dpi = 300)

```

+ Clustering with expresison matrix batch corrected by ComBat


```{r}

### iPSC and Nigra samples clustering 
 
# + Similarity between expression profiles measured as the Ward clustering from the euclidean distance of (1 - rho). Where rho is the spearman correlation between each pair of samples.
rho <- cor(combat_combined_data, method = "spearman")
```



```{r echo=FALSE, fig.height=4, fig.width=8, include=T}
#+ The spearman correlation range from `r signif(min(rho), 3)` to 
#`r signif(max(rho[upper.tri(rho, diag = FALSE)]), 3)`.
#tiff("./Summed_organoid_pseudobulk_brainspan/Summed_organoid_populations_brainspan_clustering_my_version_ComBat_average.tiff", res=300, height=4, width=9, units = "in")
par(mar = c(6, 5, 4, 6), mfrow = c(1, 1))
for(j in c(1:length(coloresB))){
  d1 <- as.dendrogram(hclust(as.dist(1 - rho), method = "ward.D2"))
  dendextend::labels_colors(d1) <- get(coloresB[j])[match(labels(d1), combined_metadata$Sample_ID)]
  dendextend::labels_cex(d1) <- 0.4
  plot(d1, ylab = "Distance (1 - rho)", main = nomsB[j],cex.axis =0.5)
  rm(d1)
  legend("topright", legend = unique(combined_metadata[, which(colnames(combined_metadata) == nomsB[j])]), cex = .6, 
         fill = unique(get(coloresB[j])), bty = "n", ncol = 2, xpd = TRUE, inset = -.05)
}
rm(rho, j)
#par(mfrow = c(1, 1), mar = c(0,0,0,0))

```



```{r}
sessionInfo()
```

